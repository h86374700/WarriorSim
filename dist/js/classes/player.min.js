class Player{static getConfig(t){return{race:$('select[name="race"]').val(),aqbooks:"Yes"==$('select[name="aqbooks"]').val(),weaponrng:"Yes"==$('select[name="weaponrng"]').val(),spelldamage:parseInt($('input[name="spelldamage"]').val()),target:{level:parseInt($('input[name="targetlevel"]').val()),basearmor:parseInt($('input[name="targetarmor"]').val()),armor:parseInt($('input[name="targetarmor"]').val()),defense:5*parseInt($('input[name="targetlevel"]').val()),mitigation:1-parseInt($('input[name="targetresistance"]').val())/6e3*15,binaryresist:parseInt(1e4-8300*(1-.15*parseInt($('input[name="targetresistance"]').val())/60))}}}constructor(t,s,e,a){a||(a=Player.getConfig()),this.rage=0,this.level=60,this.timer=0,this.itemtimer=0,this.dodgetimer=0,this.extraattacks=0,this.batchedextras=0,this.nextswinghs=!1,this.nextswingcl=!1,this.race=a.race,this.aqbooks=a.aqbooks,this.weaponrng=a.weaponrng,this.spelldamage=a.spelldamage,1==e?(this.testEnch=t,this.testEnchType=s):2==e?(this.testTempEnch=t,this.testTempEnchType=s):(this.testItem=t,this.testItemType=s),this.target=a.target,this.base={ap:0,agi:0,str:0,hit:0,crit:0,spellcrit:0,skill_0:5*this.level,skill_1:5*this.level,skill_2:5*this.level,skill_3:5*this.level,skill_4:5*this.level,skill_5:5*this.level,haste:1,strmod:1,agimod:1,dmgmod:1,apmod:1},this.stats={},this.auras={},this.spells={},this.items=[],this.addRace(),this.addTalents(),this.addGear(),this.mh&&(this.addSets(),this.addEnchants(),this.addTempEnchants(),this.addBuffs(),this.addSpells(),this.talents.flurry&&(this.auras.flurry=new Flurry(this)),this.spells.overpower&&(this.auras.battlestance=new BattleStance(this)),this.spells.bloodrage&&(this.auras.bloodrage=new BloodrageAura(this)),this.items.includes(9449)&&(this.auras.pummeler=new Pummeler(this)),this.items.includes(14554)&&(this.auras.cloudkeeper=new Cloudkeeper(this)),this.items.includes(20130)&&(this.auras.flask=new Flask(this)),this.items.includes(23041)&&(this.auras.slayer=new Slayer(this)),this.items.includes(22954)&&(this.auras.spider=new Spider(this)),this.items.includes(23570)&&(this.auras.gabbar=new Gabbar(this)),this.items.includes(21180)&&(this.auras.earthstrike=new Earthstrike(this)),this.items.includes(21670)&&(this.auras.swarmguard=new Swarmguard(this)),this.items.includes(19949)&&(this.auras.zandalarian=new Zandalarian(this)),this.update(),this.oh&&(this.oh.timer=Math.round(1e3*this.oh.speed/this.stats.haste/2)))}addRace(){for(let t of races)t.name==this.race&&(this.base.aprace=t.ap,this.base.ap+=t.ap,this.base.str+=t.str,this.base.agi+=t.agi,this.base.skill_0+=t.skill_0,this.base.skill_1+=t.skill_1,this.base.skill_2+=t.skill_2,this.base.skill_3+=t.skill_3)}addTalents(){this.talents={};for(let t in talents)for(let s of talents[t].t)this.talents=Object.assign(this.talents,s.aura(s.c))}addGear(){for(let type in gear)for(let item of gear[type])if(this.testItemType==type&&this.testItem==item.id||this.testItemType!=type&&item.selected){for(let t in this.base)this.base[t]+=item[t]||0;if(item.skill&&item.skill>0)if("Varied"==item.type)this.base.skill_1+=item.skill,this.base.skill_2+=item.skill,this.base.skill_3+=item.skill;else{let t=WEAPONTYPE[item.type.toUpperCase()];this.base["skill_"+t]+=item.skill}if("mainhand"!=type&&"offhand"!=type&&"twohand"!=type||this.addWeapon(item,type),17111==item.id&&(this.attackproc={},this.attackproc.chance=100*item.procchance,this.attackproc.magicdmg=item.magicdmg),item.procchance&&("trinket1"==type||"trinket2"==type)){let proc={};proc.chance=100*item.procchance,proc.extra=item.procextra,proc.magicdmg=item.magicdmg,item.procspell&&(this.auras[item.procspell.toLowerCase()]=eval("new "+item.procspell+"(this)"),proc.spell=this.auras[item.procspell.toLowerCase()]),this["trinketproc"+(this.trinketproc1?2:1)]=proc}this.items.push(item.id)}if(this.mh&&this.mh.twohand)for(let t in gear)for(let s of gear[t])if(("hands"==t||"head"==t)&&(this.testItemType==t&&this.testItem==s.id||this.testItemType!=t&&s.selected)&&s.skill&&s.skill>0)if("Varied"==s.type)this.base.skill_1-=s.skill,this.base.skill_2-=s.skill,this.base.skill_3-=s.skill;else{let t=WEAPONTYPE[s.type.toUpperCase()];this.base["skill_"+t]-=s.skill}}addWeapon(t,s){let e,a;for(let t of enchant[s])t.temp||(this.testEnchType==s&&this.testEnch==t.id?e=t:this.testEnchType!=s&&t.selected&&(e=t));for(let t of enchant[s])t.temp&&(this.testTempEnchType==s&&this.testTempEnch==t.id?a=t:this.testTempEnchType!=s&&t.selected&&(a=t));"mainhand"==s&&(this.mh=new Weapon(this,t,e,a,!1,!1)),"offhand"==s&&(this.oh=new Weapon(this,t,e,a,!0,!1)),"twohand"==s&&(this.mh=new Weapon(this,t,e,a,!1,!0))}addEnchants(){for(let t in enchant)for(let s of enchant[t])if(!s.temp&&(this.testEnchType==t&&this.testEnch==s.id||this.testEnchType!=t&&s.selected))for(let t in this.base)"haste"==t?this.base.haste*=1+s.haste/100||1:this.base[t]+=s[t]||0}addTempEnchants(){for(let t in enchant)for(let s of enchant[t])if(s.temp&&("mainhand"!=t||!this.mh.windfury)&&(this.testTempEnchType==t&&this.testTempEnch==s.id||this.testTempEnchType!=t&&s.selected))for(let t in this.base)"haste"==t?this.base.haste*=1+s.haste/100||1:this.base[t]+=s[t]||0}addSets(){for(let set of sets){let counter=0;for(let t of set.items)this.items.includes(t)&&counter++;if(0!=counter)for(let bonus of set.bonus)if(counter>=bonus.count){for(let t in bonus.stats)this.base[t]+=bonus.stats[t]||0;bonus.stats.procspell&&(this.attackproc={},this.attackproc.chance=100*bonus.stats.procchance,this.auras[bonus.stats.procspell.toLowerCase()]=eval("new "+bonus.stats.procspell+"(this)"),this.attackproc.spell=this.auras[bonus.stats.procspell.toLowerCase()]),bonus.stats.enhancedbs&&(this.enhancedbs=!0)}}}addBuffs(){for(let t of buffs)if(t.active){let s=0;if("battleshout"==t.group){let e=this.aqbooks?t.ap+39:t.ap;27578==t.id&&this.enhancedbs&&(e+=30),s=(e=~~(e*(1+this.talents.impbattleshout)))-t.ap}"zerkstance"==t.group&&(this.zerkstance=!0),"vaelbuff"==t.group&&(this.vaelbuff=!0),"dragonbreath"==t.group&&(this.dragonbreath=!0),this.base.ap+=(t.ap||0)+s,this.base.agi+=t.agi||0,this.base.str+=t.str||0,this.base.crit+=t.crit||0,this.base.hit+=t.hit||0,this.base.spellcrit+=t.spellcrit||0,this.base.agimod*=1+t.agimod/100||1,this.base.strmod*=1+t.strmod/100||1,this.base.dmgmod*=1+t.dmgmod/100||1,this.base.haste*=1+t.haste/100||1,"blessingmight"==t.group&&this.aqbooks&&(this.base.ap+=36),"graceair"==t.group&&this.aqbooks&&(this.base.agi+=10),"strengthearth"==t.group&&this.aqbooks&&(this.base.str+=16)}}addSpells(){for(let spell of spells)spell.active&&(spell.aura?this.auras[spell.classname.toLowerCase()]=eval(`new ${spell.classname}(this)`):this.spells[spell.classname.toLowerCase()]=eval(`new ${spell.classname}(this)`))}reset(t){this.rage=t,this.timer=0,this.itemtimer=0,this.dodgetimer=0,this.spelldelay=0,this.heroicdelay=0,this.mh.timer=0,this.oh&&(this.oh.timer=Math.round(1e3*this.oh.speed/this.stats.haste/2)),this.extraattacks=0,this.batchedextras=0,this.nextswinghs=!1,this.nextswingcl=!1;for(let t in this.spells)this.spells[t].timer=0,this.spells[t].stacks=0;for(let t in this.auras)this.auras[t].timer=0,this.auras[t].firstuse=!0,this.auras[t].stacks=0;this.update()}update(){this.updateAuras(),this.updateArmorReduction(),this.mh.glanceChance=this.getGlanceChance(this.mh),this.mh.miss=this.getMissChance(this.mh),this.mh.dwmiss=this.mh.miss,this.mh.dodge=this.getDodgeChance(this.mh),this.oh&&(this.mh.dwmiss=this.getDWMissChance(this.mh),this.oh.glanceChance=this.getGlanceChance(this.oh),this.oh.miss=this.getMissChance(this.oh),this.oh.dwmiss=this.getDWMissChance(this.oh),this.oh.dodge=this.getDodgeChance(this.oh))}updateAuras(){for(let t in this.base)this.stats[t]=this.base[t];for(let t in this.auras)if(this.auras[t].timer){for(let s in this.auras[t].stats)this.stats[s]+=this.auras[t].stats[s];for(let s in this.auras[t].mult_stats)this.stats[s]*=1+this.auras[t].mult_stats[s]/100}this.stats.str=~~(this.stats.str*this.stats.strmod),this.stats.agi=~~(this.stats.agi*this.stats.agimod),this.stats.ap+=2*this.stats.str,this.stats.crit+=this.stats.agi/20,this.crit=this.getCritChance(),1!=this.stats.apmod&&(this.stats.ap+=~~((this.base.aprace+2*this.stats.str)*(this.stats.apmod-1)))}updateStrength(){this.stats.str=this.base.str,this.stats.ap=this.base.ap;for(let t in this.auras)this.auras[t].timer&&(this.auras[t].stats.str&&(this.stats.str+=this.auras[t].stats.str),this.auras[t].stats.ap&&(this.stats.ap+=this.auras[t].stats.ap));this.stats.str=~~(this.stats.str*this.stats.strmod),this.stats.ap+=2*this.stats.str,1!=this.stats.apmod&&(this.stats.ap+=~~((this.base.aprace+2*this.stats.str)*(this.stats.apmod-1)))}updateAP(){this.stats.ap=this.base.ap;for(let t in this.auras)this.auras[t].timer&&this.auras[t].stats.ap&&(this.stats.ap+=this.auras[t].stats.ap);this.stats.ap+=2*this.stats.str,1!=this.stats.apmod&&(this.stats.ap+=~~((this.base.aprace+2*this.stats.str)*(this.stats.apmod-1)))}updateHaste(){this.stats.haste=this.base.haste,this.auras.flurry&&this.auras.flurry.timer&&(this.stats.haste*=1+this.auras.flurry.mult_stats.haste/100),this.auras.berserking&&this.auras.berserking.timer&&(this.stats.haste*=1+this.auras.berserking.mult_stats.haste/100),this.auras.empyrean&&this.auras.empyrean.timer&&(this.stats.haste*=1+this.auras.empyrean.mult_stats.haste/100),this.auras.eskhandar&&this.auras.eskhandar.timer&&(this.stats.haste*=1+this.auras.eskhandar.mult_stats.haste/100),this.auras.pummeler&&this.auras.pummeler.timer&&(this.stats.haste*=1+this.auras.pummeler.mult_stats.haste/100),this.auras.spider&&this.auras.spider.timer&&(this.stats.haste*=1+this.auras.spider.mult_stats.haste/100)}updateBonusDmg(){let t=0;this.auras.zeal&&this.auras.zeal.timer&&(t+=this.auras.zeal.stats.bonusdmg),this.auras.zandalarian&&this.auras.zandalarian.timer&&(t+=this.auras.zandalarian.stats.bonusdmg),this.mh.bonusdmg=this.mh.basebonusdmg+t,this.oh&&(this.oh.bonusdmg=this.oh.basebonusdmg+t)}updateArmorReduction(){this.target.armor=this.target.basearmor,this.auras.annihilator&&this.auras.annihilator.timer&&(this.target.armor=Math.max(this.target.armor-this.auras.annihilator.stacks*this.auras.annihilator.armor,0)),this.auras.rivenspike&&this.auras.rivenspike.timer&&(this.target.armor=Math.max(this.target.armor-this.auras.rivenspike.stacks*this.auras.rivenspike.armor,0)),this.auras.bonereaver&&this.auras.bonereaver.timer&&(this.target.armor=Math.max(this.target.armor-this.auras.bonereaver.stacks*this.auras.bonereaver.armor,0)),this.auras.swarmguard&&this.auras.swarmguard.timer&&(this.target.armor=Math.max(this.target.armor-this.auras.swarmguard.stacks*this.auras.swarmguard.armor,0)),this.armorReduction=this.getArmorReduction()}updateDmgMod(){this.stats.dmgmod=this.base.dmgmod;for(let t in this.auras)this.auras[t].timer&&this.auras[t].mult_stats.dmgmod&&(this.stats.dmgmod*=1+this.auras[t].mult_stats.dmgmod/100)}getGlanceReduction(t){let s=this.target.defense-this.stats["skill_"+t.type],e=1.3-.05*s,a=1.2-.03*s;return this.weaponrng?rng(1e3*Math.min(e,.91),1e3*Math.min(a,.99))/1e3:avg(1e3*Math.min(e,.91),1e3*Math.min(a,.99))/1e3}getGlanceChance(t){return 10+2*(this.target.defense-Math.min(5*this.level,this.stats["skill_"+t.type]))}getMissChance(t){let s=this.target.defense-this.stats["skill_"+t.type],e=5+(s>10?.2*s:.1*s);return e-=s>10?this.stats.hit-1:this.stats.hit}getDWMissChance(t){let s=this.target.defense-this.stats["skill_"+t.type],e=5+(s>10?.2*s:.1*s);return e=.8*e+20,e-=s>10?this.stats.hit-1:this.stats.hit}getCritChance(){let t=this.stats.crit+(this.talents.crit||0)+1*(this.level-this.target.level)+.6*(this.level-this.target.level);return Math.max(t,0)}getDodgeChance(t){return 5+.1*(this.target.defense-this.stats["skill_"+t.type])}getArmorReduction(){let t=this.target.armor/(this.target.armor+400+85*this.level);return t>.75?.75:t}addRage(t,s,e,a){(!a||a instanceof HeroicStrike||a instanceof HeroicStrikeExecute)&&s!=RESULT.MISS&&s!=RESULT.DODGE&&this.talents.umbridledwrath&&rng10k()<100*this.talents.umbridledwrath&&(this.rage+=1),a?(a instanceof Execute&&(a.result=s),s!=RESULT.MISS&&s!=RESULT.DODGE||(this.rage+=a.refund?.8*a.cost:0)):s==RESULT.DODGE?this.rage+=e.avgdmg()/230.6*7.5*.75:s!=RESULT.MISS&&(this.rage+=t/230.6*7.5),this.rage>100&&(this.rage=100)}steptimer(t){return this.timer<=t?(this.timer=0,!0):(this.timer-=t,!1)}stepitemtimer(t){return this.itemtimer<=t?(this.itemtimer=0,!0):(this.itemtimer-=t,!1)}stepdodgetimer(t){this.dodgetimer<=t?this.dodgetimer=0:this.dodgetimer-=t}stepauras(){this.mh.proc1&&this.mh.proc1.spell&&this.mh.proc1.spell.timer&&this.mh.proc1.spell.step(),this.mh.proc2&&this.mh.proc2.spell&&this.mh.proc2.spell.timer&&this.mh.proc2.spell.step(),this.oh&&this.oh.proc1&&this.oh.proc1.spell&&this.oh.proc1.spell.timer&&this.oh.proc1.spell.step(),this.oh&&this.oh.proc2&&this.oh.proc2.spell&&this.oh.proc2.spell.timer&&this.oh.proc2.spell.step(),this.auras.mightyragepotion&&this.auras.mightyragepotion.firstuse&&this.auras.mightyragepotion.timer&&this.auras.mightyragepotion.step(),this.auras.recklessness&&this.auras.recklessness.firstuse&&this.auras.recklessness.timer&&this.auras.recklessness.step(),this.auras.deathwish&&this.auras.deathwish.firstuse&&this.auras.deathwish.timer&&this.auras.deathwish.step(),this.auras.cloudkeeper&&this.auras.cloudkeeper.firstuse&&this.auras.cloudkeeper.timer&&this.auras.cloudkeeper.step(),this.auras.flask&&this.auras.flask.firstuse&&this.auras.flask.timer&&this.auras.flask.step(),this.auras.battlestance&&this.auras.battlestance.timer&&this.auras.battlestance.step(),this.auras.bloodfury&&this.auras.bloodfury.firstuse&&this.auras.bloodfury.timer&&this.auras.bloodfury.step(),this.auras.berserking&&this.auras.berserking.firstuse&&this.auras.berserking.timer&&this.auras.berserking.step(),this.auras.slayer&&this.auras.slayer.firstuse&&this.auras.slayer.timer&&this.auras.slayer.step(),this.auras.spider&&this.auras.spider.firstuse&&this.auras.spider.timer&&this.auras.spider.step(),this.auras.earthstrike&&this.auras.earthstrike.firstuse&&this.auras.earthstrike.timer&&this.auras.earthstrike.step(),this.auras.pummeler&&this.auras.pummeler.firstuse&&this.auras.pummeler.timer&&this.auras.pummeler.step(),this.auras.swarmguard&&this.auras.swarmguard.firstuse&&this.auras.swarmguard.timer&&this.auras.swarmguard.step(),this.auras.zandalarian&&this.auras.zandalarian.firstuse&&this.auras.zandalarian.timer&&this.auras.zandalarian.step(),this.mh.windfury&&this.mh.windfury.timer&&this.mh.windfury.step(),this.trinketproc1&&this.trinketproc1.spell&&this.trinketproc1.spell.timer&&this.trinketproc1.spell.step(),this.trinketproc2&&this.trinketproc2.spell&&this.trinketproc2.spell.timer&&this.trinketproc2.spell.step(),this.attackproc&&this.attackproc.spell&&this.attackproc.spell.timer&&this.attackproc.spell.step()}endauras(){this.mh.proc1&&this.mh.proc1.spell&&this.mh.proc1.spell.timer&&this.mh.proc1.spell.end(),this.mh.proc2&&this.mh.proc2.spell&&this.mh.proc2.spell.timer&&this.mh.proc2.spell.end(),this.oh&&this.oh.proc1&&this.oh.proc1.spell&&this.oh.proc1.spell.timer&&this.oh.proc1.spell.end(),this.oh&&this.oh.proc2&&this.oh.proc2.spell&&this.oh.proc2.spell.timer&&this.oh.proc2.spell.end(),this.auras.mightyragepotion&&this.auras.mightyragepotion.firstuse&&this.auras.mightyragepotion.timer&&this.auras.mightyragepotion.end(),this.auras.recklessness&&this.auras.recklessness.firstuse&&this.auras.recklessness.timer&&this.auras.recklessness.end(),this.auras.deathwish&&this.auras.deathwish.firstuse&&this.auras.deathwish.timer&&this.auras.deathwish.end(),this.auras.cloudkeeper&&this.auras.cloudkeeper.firstuse&&this.auras.cloudkeeper.timer&&this.auras.cloudkeeper.end(),this.auras.flask&&this.auras.flask.firstuse&&this.auras.flask.timer&&this.auras.flask.end(),this.auras.battlestance&&this.auras.battlestance.timer&&this.auras.battlestance.end(),this.auras.bloodfury&&this.auras.bloodfury.firstuse&&this.auras.bloodfury.timer&&this.auras.bloodfury.end(),this.auras.berserking&&this.auras.berserking.firstuse&&this.auras.berserking.timer&&this.auras.berserking.end(),this.auras.slayer&&this.auras.slayer.firstuse&&this.auras.slayer.timer&&this.auras.slayer.end(),this.auras.spider&&this.auras.spider.firstuse&&this.auras.spider.timer&&this.auras.spider.end(),this.auras.gabbar&&this.auras.gabbar.firstuse&&this.auras.gabbar.timer&&this.auras.gabbar.end(),this.auras.earthstrike&&this.auras.earthstrike.firstuse&&this.auras.earthstrike.timer&&this.auras.earthstrike.end(),this.auras.pummeler&&this.auras.pummeler.firstuse&&this.auras.pummeler.timer&&this.auras.pummeler.end(),this.auras.swarmguard&&this.auras.swarmguard.firstuse&&this.auras.swarmguard.timer&&this.auras.swarmguard.end(),this.auras.zandalarian&&this.auras.zandalarian.firstuse&&this.auras.zandalarian.timer&&this.auras.zandalarian.end(),this.mh.windfury&&this.mh.windfury.timer&&this.mh.windfury.end(),this.trinketproc1&&this.trinketproc1.spell&&this.trinketproc1.spell.timer&&this.trinketproc1.spell.end(),this.trinketproc2&&this.trinketproc2.spell&&this.trinketproc2.spell.timer&&this.trinketproc2.spell.end(),this.attackproc&&this.attackproc.spell&&this.attackproc.spell.timer&&this.attackproc.spell.end(),this.auras.flurry&&this.auras.flurry.timer&&this.auras.flurry.end()}rollweapon(t){let s=0,e=rng10k();return e<(s+=100*Math.max(this.nextswinghs?t.miss:t.dwmiss,0))?RESULT.MISS:e<(s+=100*t.dodge)?RESULT.DODGE:e<(s+=100*t.glanceChance)?RESULT.GLANCE:e<(s+=100*(this.crit+t.crit))?RESULT.CRIT:RESULT.HIT}rollspell(t){let s=0,e=rng10k();if(e<(s+=100*Math.max(this.mh.miss,0)))return RESULT.MISS;if(t.canDodge&&e<(s+=100*this.mh.dodge))return RESULT.DODGE;t.weaponspell||(e=rng10k(),s=0);let a=this.crit+this.mh.crit;return t instanceof Overpower&&(a+=this.talents.overpowercrit),e<(s+=100*a)&&!t.nocrit?RESULT.CRIT:RESULT.HIT}attackmh(t){this.stepauras();let s,e=null,a=0;this.nextswinghs?(this.nextswinghs=!1,this.spells.heroicstrike&&this.spells.heroicstrike.cost<=this.rage?(s=this.rollspell(this.spells.heroicstrike),e=this.spells.heroicstrike,this.rage-=e.cost):this.spells.heroicstrikeexecute&&this.spells.heroicstrikeexecute.cost<=this.rage?(s=this.rollspell(this.spells.heroicstrikeexecute),e=this.spells.heroicstrikeexecute,this.rage-=e.cost):s=this.rollweapon(t)):s=this.rollweapon(t);let i=t.dmg(e);a=this.procattack(e,t,s),s==RESULT.DODGE&&(this.dodgetimer=5e3),s==RESULT.GLANCE&&(i*=this.getGlanceReduction(t)),s==RESULT.CRIT&&(i*=2+(e?this.talents.abilitiescrit:0),this.proccrit()),t.use();let r=this.dealdamage(i,s,t,e);return e?(e.totaldmg+=r,e.data[s]++):(t.totaldmg+=r,t.data[s]++),t.totalprocdmg+=a,r+a}attackoh(t){this.stepauras();let s,e=0;s=this.rollweapon(t);let a=t.dmg();e=this.procattack(null,t,s),s==RESULT.DODGE&&(this.dodgetimer=5e3),s==RESULT.GLANCE&&(a*=this.getGlanceReduction(t)),s==RESULT.CRIT&&(a*=2,this.proccrit()),t.use();let i=this.dealdamage(a,s,t);return t.data[s]++,t.totaldmg+=i,t.totalprocdmg+=e,i+e}cast(t){if(this.stepauras(),t.use(),t.useonly)return 0;let s=0,e=t.dmg()*this.mh.modifier,a=this.rollspell(t);s=this.procattack(t,this.mh,a),a==RESULT.DODGE&&(this.dodgetimer=5e3),a==RESULT.CRIT&&(e*=2+this.talents.abilitiescrit,this.proccrit());let i=this.dealdamage(e,a,this.mh,t);return t.data[a]++,t.totaldmg+=i,this.mh.totalprocdmg+=s,i+s}dealdamage(t,s,e,a){return s!=RESULT.MISS&&s!=RESULT.DODGE?(t*=this.stats.dmgmod,t*=1-this.armorReduction,this.addRage(t,s,e,a),~~t):(this.addRage(t,s,e,a),0)}proccrit(){this.auras.flurry&&this.auras.flurry.use(),this.auras.deepwounds&&this.auras.deepwounds.use()}procattack(t,s,e){let a=0;return e!=RESULT.MISS&&e!=RESULT.DODGE&&(s.proc1&&rng10k()<s.proc1.chance&&(s.proc1.spell&&s.proc1.spell.use(),s.proc1.magicdmg&&(a+=this.magicproc(s.proc1)),s.proc1.physdmg&&(a+=this.physproc(s.proc1.physdmg)),s.proc1.extra&&(this.extraattacks+=s.proc1.extra)),s.proc2&&rng10k()<s.proc2.chance&&(s.proc2.spell&&s.proc2.spell.use(),s.proc2.magicdmg&&(a+=this.magicproc(s.proc2))),s.windfury&&!this.auras.windfury.timer&&rng10k()<2e3&&s.windfury.use(),this.trinketproc1&&rng10k()<this.trinketproc1.chance&&(this.trinketproc1.extra&&(this.batchedextras+=this.trinketproc1.extra),this.trinketproc1.magicdmg&&(a+=this.magicproc(this.trinketproc1)),this.trinketproc1.spell&&this.trinketproc1.spell.use()),this.trinketproc2&&rng10k()<this.trinketproc2.chance&&(this.trinketproc2.extra&&(this.batchedextras+=this.trinketproc2.extra),this.trinketproc2.magicdmg&&(a+=this.magicproc(this.trinketproc2)),this.trinketproc2.spell&&this.trinketproc2.spell.use()),this.attackproc&&rng10k()<this.attackproc.chance&&(this.attackproc.magicdmg&&(a+=this.magicproc(this.attackproc)),this.attackproc.spell&&this.attackproc.spell.use()),this.talents.swordproc&&s.type==WEAPONTYPE.SWORD&&rng10k()<100*this.talents.swordproc&&this.extraattacks++,this.auras.swarmguard&&this.auras.swarmguard.timer&&rng10k()<this.auras.swarmguard.chance&&this.auras.swarmguard.proc(),this.auras.zandalarian&&this.auras.zandalarian.timer&&this.auras.zandalarian.proc(),this.dragonbreath&&rng10k()<400&&(a+=this.magicproc({magicdmg:60,coeff:1}))),(!t||t instanceof HeroicStrike||t instanceof HeroicStrikeExecute)&&(this.auras.flurry&&this.auras.flurry.stacks&&this.auras.flurry.proc(),this.mh.windfury&&this.mh.windfury.stacks&&this.mh.windfury.proc()),a}magicproc(t){let s=1,e=1700,a=t.magicdmg;return t.gcd&&this.timer&&this.timer<1500?0:(t.binaryspell?e=this.target.binaryresist:s*=this.target.mitigation,rng10k()<e?0:(rng10k()<100*this.stats.spellcrit&&(s*=1.5),t.coeff&&(a+=this.spelldamage*t.coeff),~~(a*s)))}physproc(t){let s=0,e=rng10k();return e<(s+=100*Math.max(this.mh.miss,0))&&(t=0),e<(s+=100*this.mh.dodge)&&(this.dodgetimer=5e3,t=0),(e=rng10k())<100*(this.crit+this.mh.crit)&&(t*=2),t*this.stats.dmgmod*this.mh.modifier}serializeStats(){return{auras:this.auras,spells:this.spells,mh:this.mh,oh:this.oh}}log(t){console.log(`${step.toString().padStart(5," ")} | ${this.rage.toFixed(2).padStart(6," ")} | ${t}`)}}