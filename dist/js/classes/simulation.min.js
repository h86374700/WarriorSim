var RESULT={HIT:0,MISS:1,DODGE:2,CRIT:3,GLANCE:4},step=0,log=!1,version=4;const TYPE={UPDATE:0,FINISHED:1};class SimulationWorker{constructor(e,s,a){this.worker=new Worker("./dist/js/sim-worker.min.js"),this.worker.onerror=a,this.worker.onmessage=(t=>{const[r,...l]=t.data;switch(r){case TYPE.UPDATE:s(...l);break;case TYPE.FINISHED:e(...l);break;default:a(`Unexpected type: ${r}`)}})}start(e){e.globals=getGlobalsDelta(),this.worker.postMessage(e)}}class Simulation{static getConfig(){return{timesecsmin:parseInt($('input[name="timesecsmin"]').val()),timesecsmax:parseInt($('input[name="timesecsmax"]').val()),executeperc:parseInt($('input[name="executeperc"]').val()),startrage:parseInt($('input[name="startrage"]').val()),iterations:parseInt($('input[name="simulations"]').val()),priorityap:parseInt(spells[4].priorityap)}}constructor(e,s,a,t){t||(t=Simulation.getConfig()),this.player=e,this.timesecsmin=t.timesecsmin,this.timesecsmax=t.timesecsmax,this.executeperc=t.executeperc,this.startrage=t.startrage,this.iterations=t.iterations,this.idmg=0,this.totaldmg=0,this.totalduration=0,this.mindps=99999,this.maxdps=0,this.maxcallstack=Math.min(Math.floor(this.iterations/10),1e3),this.starttime=0,this.endtime=0,this.cb_update=a,this.cb_finished=s,this.spread=[],this.priorityap=parseInt(spells[4].priorityap),log=1==this.iterations}startSync(){let e;for(this.starttime=(new Date).getTime(),e=1;e<this.iterations;++e)this.run(),e%this.maxcallstack==0&&this.update(e);this.endtime=(new Date).getTime(),this.finished()}startAsync(){this.starttime=(new Date).getTime(),this.runAsync(1)}runAsync(e){this.run(),e==this.iterations?(this.endtime=(new Date).getTime(),this.finished()):e%this.maxcallstack==0?(this.update(e),setTimeout(()=>this.runAsync(e+1),0)):this.runAsync(e+1)}run(){step=0,this.idmg=0;let e,s,a=this.player;a.reset(this.startrage),this.maxsteps=rng(1e3*this.timesecsmin,1e3*this.timesecsmax),this.duration=this.maxsteps/1e3,this.executestep=this.maxsteps-parseInt(this.maxsteps*(this.executeperc/100));let t=!1,r=0,l=0;for(a.auras.flask&&(this.flaskstep=Math.max(this.maxsteps-6e4,0),l+=6e4),a.auras.cloudkeeper&&(this.cloudstep=Math.max(this.maxsteps-l-3e4,0),l+=3e4),a.auras.slayer&&(this.slayerstep=Math.max(this.maxsteps-l-2e4,0),l+=2e4),a.auras.spider&&(this.spiderstep=Math.max(this.maxsteps-l-15e3,0),l+=15e3),a.auras.gabbar&&(this.gabbarstep=Math.max(this.maxsteps-l-2e4,0),l+=2e4),a.auras.earthstrike&&(this.earthstep=Math.max(this.maxsteps-l-2e4,0),l+=2e4),a.auras.pummeler&&(this.pummelstep=Math.max(this.maxsteps-l-3e4,0),l+=3e4),a.auras.zandalarian&&(this.zandalarstep=Math.max(this.maxsteps-l-2e4,0),l+=2e4),a.auras.deathwish&&(a.auras.deathwish.usestep=Math.max(this.maxsteps-a.auras.deathwish.timetoend,0)),a.auras.recklessness&&(a.auras.recklessness.usestep=Math.max(this.maxsteps-a.auras.recklessness.timetoend,0)),a.auras.mightyragepotion&&(a.auras.mightyragepotion.usestep=Math.max(this.maxsteps-a.auras.mightyragepotion.timetoend,0)),a.auras.berserking&&(a.auras.berserking.usestep=Math.max(this.maxsteps-a.auras.berserking.timetoend,0)),a.auras.bloodfury&&(a.auras.bloodfury.usestep=Math.max(this.maxsteps-a.auras.bloodfury.timetoend,0)),a.auras.swarmguard&&(a.auras.swarmguard.usestep=Math.max(this.maxsteps-a.auras.swarmguard.timetoend,0));step<this.maxsteps;)if(0!=r&&step%3e3==0&&a.talents.angermanagement&&(a.rage=a.rage>=99?100:a.rage+1,t=!0),a.vaelbuff&&0!=r&&step%1e3==0&&(a.rage=a.rage>=80?100:a.rage+20,t=!0),a.mh.timer<=0&&(this.idmg+=a.attackmh(a.mh),t=!0),a.oh&&a.oh.timer<=0&&(this.idmg+=a.attackoh(a.oh),t=!0),t&&!a.spelldelay&&(a.auras.swarmguard&&a.auras.swarmguard.canUse()?(a.spelldelay=1,e=a.auras.swarmguard):a.auras.mightyragepotion&&a.auras.mightyragepotion.canUse()?(a.spelldelay=1,e=a.auras.mightyragepotion):a.spells.bloodrage&&a.spells.bloodrage.canUse()?(a.spelldelay=1,e=a.spells.bloodrage):a.timer||(a.auras.flask&&a.auras.flask.canUse()&&step>this.flaskstep?(a.spelldelay=1,e=a.auras.flask):a.auras.cloudkeeper&&a.auras.cloudkeeper.canUse()&&step>this.cloudstep?(a.spelldelay=1,e=a.auras.cloudkeeper):a.auras.recklessness&&a.auras.recklessness.canUse()?(a.spelldelay=1,e=a.auras.recklessness):a.auras.deathwish&&a.auras.deathwish.canUse()?(a.spelldelay=1,e=a.auras.deathwish):a.auras.bloodfury&&a.auras.bloodfury.canUse()?(a.spelldelay=1,e=a.auras.bloodfury):a.auras.berserking&&a.auras.berserking.canUse()?(a.spelldelay=1,e=a.auras.berserking):a.auras.slayer&&a.auras.slayer.canUse()&&step>this.slayerstep?(a.spelldelay=1,e=a.auras.slayer):a.auras.spider&&a.auras.spider.canUse()&&step>this.spiderstep?(a.spelldelay=1,e=a.auras.spider):a.auras.gabbar&&a.auras.gabbar.canUse()&&step>this.gabbarstep?(a.spelldelay=1,e=a.auras.gabbar):a.auras.earthstrike&&a.auras.earthstrike.canUse()&&step>this.earthstep?(a.spelldelay=1,e=a.auras.earthstrike):a.auras.pummeler&&a.auras.pummeler.canUse()&&step>this.pummelstep?(a.spelldelay=1,e=a.auras.pummeler):a.auras.zandalarian&&a.auras.zandalarian.canUse()&&step>this.zandalarstep?(a.spelldelay=1,e=a.auras.zandalarian):a.spells.execute&&step>=this.executestep?a.spells.bloodthirst&&a.stats.ap>=this.priorityap&&a.spells.bloodthirst.canUse()?(a.spelldelay=1,e=a.spells.bloodthirst):a.spells.mortalstrike&&a.stats.ap>=this.priorityap&&a.spells.mortalstrike.canUse()?(a.spelldelay=1,e=a.spells.mortalstrike):a.spells.execute.canUse()&&(a.spelldelay=1,e=a.spells.execute):a.spells.sunderarmor&&a.spells.sunderarmor.canUse()?(a.spelldelay=1,e=a.spells.sunderarmor):a.spells.bloodthirst&&a.spells.bloodthirst.canUse()?(a.spelldelay=1,e=a.spells.bloodthirst):a.spells.mortalstrike&&a.spells.mortalstrike.canUse()?(a.spelldelay=1,e=a.spells.mortalstrike):a.spells.whirlwind&&a.spells.whirlwind.canUse()?(a.spelldelay=1,e=a.spells.whirlwind):a.spells.overpower&&a.spells.overpower.canUse()?(a.spelldelay=1,e=a.spells.overpower):a.spells.hamstring&&a.spells.hamstring.canUse()&&(a.spelldelay=1,e=a.spells.hamstring)),a.heroicdelay&&(t=!1)),t&&!a.heroicdelay&&(!a.spells.execute||step<this.executestep?a.spells.heroicstrike&&a.spells.heroicstrike.canUse()&&(a.heroicdelay=1,s=a.spells.heroicstrike):a.spells.heroicstrikeexecute&&a.spells.heroicstrikeexecute.canUse()&&(a.heroicdelay=1,s=a.spells.heroicstrikeexecute),t=!1),a.spelldelay&&e&&a.spelldelay>e.maxdelay&&(a.heroicdelay&&s&&a.heroicdelay>s.maxdelay&&(a.heroicdelay=s.maxdelay-49),e.canUse()?(this.idmg+=a.cast(e),a.spelldelay=0,t=!0):a.spelldelay=0),a.heroicdelay&&s&&a.heroicdelay>s.maxdelay&&(s.canUse()?(a.cast(s),a.heroicdelay=0,t=!0):a.heroicdelay=0),a.spells.heroicstrike&&a.spells.heroicstrike.unqueue&&a.nextswinghs&&a.rage<a.spells.heroicstrike.unqueue&&a.mh.timer<=a.spells.heroicstrike.unqueuetimer&&(this.player.nextswinghs=!1),a.extraattacks>0&&(a.mh.timer=0,a.extraattacks--),a.batchedextras>0&&(a.mh.timer=400-step%400,a.batchedextras--),!a.mh.timer||!a.spelldelay&&t||!a.heroicdelay&&t)r=0;else{if(r=Math.min(a.mh.timer,a.oh?a.oh.timer:9999),a.spelldelay&&e.maxdelay-a.spelldelay<r&&(r=e.maxdelay-a.spelldelay+1),a.heroicdelay&&s.maxdelay-a.heroicdelay<r&&(r=s.maxdelay-a.heroicdelay+1),a.timer&&a.timer<r&&(r=a.timer),a.itemtimer&&a.itemtimer<r&&(r=a.itemtimer),a.talents.angermanagement&&3e3-step%3e3<r&&(r=3e3-step%3e3),a.vaelbuff&&1e3-step%1e3<r&&(r=1e3-step%1e3),a.auras.bloodrage&&a.auras.bloodrage.timer&&1e3-(step-a.auras.bloodrage.starttimer)%1e3<r&&(r=1e3-(step-a.auras.bloodrage.starttimer)%1e3),a.auras.gabbar&&a.auras.gabbar.timer&&2e3-(step-a.auras.gabbar.starttimer)%2e3<r&&(r=2e3-(step-a.auras.gabbar.starttimer)%2e3),a.spells.bloodthirst&&a.spells.bloodthirst.timer&&a.spells.bloodthirst.timer<r&&(r=a.spells.bloodthirst.timer),a.spells.mortalstrike&&a.spells.mortalstrike.timer&&a.spells.mortalstrike.timer<r&&(r=a.spells.mortalstrike.timer),a.spells.whirlwind&&a.spells.whirlwind.timer&&a.spells.whirlwind.timer<r&&(r=a.spells.whirlwind.timer),a.spells.bloodrage&&a.spells.bloodrage.timer&&a.spells.bloodrage.timer<r&&(r=a.spells.bloodrage.timer),a.spells.overpower&&a.spells.overpower.timer&&a.spells.overpower.timer<r&&(r=a.spells.overpower.timer),a.spells.execute&&a.spells.execute.timer&&a.spells.execute.timer<r&&(r=a.spells.execute.timer),a.spells.heroicstrike&&a.spells.heroicstrike.unqueue){let e=Math.max(a.mh.timer-a.spells.heroicstrike.unqueuetimer);e>0&&e<r&&(r=e)}step+=r,a.mh.step(r),a.oh&&a.oh.step(r),a.timer&&a.steptimer(r)&&!a.spelldelay&&(t=!0),a.itemtimer&&a.stepitemtimer(r)&&!a.spelldelay&&(t=!0),a.dodgetimer&&a.stepdodgetimer(r),a.spelldelay&&(a.spelldelay+=r),a.heroicdelay&&(a.heroicdelay+=r),a.spells.bloodthirst&&a.spells.bloodthirst.timer&&!a.spells.bloodthirst.step(r)&&!a.spelldelay&&(t=!0),a.spells.mortalstrike&&a.spells.mortalstrike.timer&&!a.spells.mortalstrike.step(r)&&!a.spelldelay&&(t=!0),a.spells.whirlwind&&a.spells.whirlwind.timer&&!a.spells.whirlwind.step(r)&&!a.spelldelay&&(t=!0),a.spells.bloodrage&&a.spells.bloodrage.timer&&!a.spells.bloodrage.step(r)&&!a.spelldelay&&(t=!0),a.spells.overpower&&a.spells.overpower.timer&&!a.spells.overpower.step(r)&&!a.spelldelay&&(t=!0),a.spells.execute&&a.spells.execute.timer&&!a.spells.execute.step(r)&&!a.spelldelay&&(t=!0),a.auras.bloodrage&&a.auras.bloodrage.timer&&!a.auras.bloodrage.step()&&!a.spelldelay&&(t=!0),a.auras.gabbar&&a.auras.gabbar.timer&&a.auras.gabbar.step()}a.endauras(),this.totaldmg+=this.idmg,this.totalduration+=this.duration;let i=this.idmg/this.duration;i<this.mindps&&(this.mindps=i),i>this.maxdps&&(this.maxdps=i),i=Math.round(i),this.spread[i]?this.spread[i]++:this.spread[i]=1}update(e){this.cb_update&&this.cb_update(e,{iterations:this.iterations,totaldmg:this.totaldmg,totalduration:this.totalduration})}finished(){this.cb_finished&&this.cb_finished({iterations:this.iterations,totaldmg:this.totaldmg,totalduration:this.totalduration,mindps:this.mindps,maxdps:this.maxdps,starttime:this.starttime,endtime:this.endtime})}}function rng(e,s){return~~(Math.random()*(s-e+1)+e)}function rng10k(){return~~(1e4*Math.random())}function avg(e,s){return(e+s)/2}